name: Dioxus Bundle

on:
    workflow_call:
        inputs:
            platform:
                description: "Platform to build (desktop, web, android, ios, or all)"
                required: false
                type: string
                default: "all"

permissions:
    contents: write

jobs:
    build-desktop:
        if: ${{ inputs.platform == 'all' || inputs.platform == 'desktop' }}
        name: Desktop (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]

        steps:
            - uses: nigeleke/github/.github/actions/os-prerequisites@main
              with:
                  os: ${{ matrix.os }}

            - uses: nigeleke/github/.github/actions/dioxus-setup@main

            - uses: nigeleke/github/.github/actions/dioxus-bundle@main
              with:
                  platform: desktop

            - name: Collect desktop bundles
              shell: bash
              run: |
                  mkdir -p artifacts
                  if [ "${{ runner.os }}" = "Linux" ]; then
                    cp target/dx/*/bundle/linux/bundle/deb/*.deb artifacts/ 2>/dev/null || true
                    cp target/dx/*/bundle/linux/bundle/rpm/*.rpm artifacts/ 2>/dev/null || true
                    cp target/dx/*/bundle/linux/bundle/appimage/*.AppImage artifacts/ 2>/dev/null || true
                  elif [ "${{ runner.os }}" = "Windows" ]; then
                    cp target\dx\*\bundle\windows\bundle/msi/*.msi artifacts/ 2>/dev/null || true
                    cp target\dx\*\bundle\windows\bundle/nsis/*.exe artifacts/ 2>/dev/null || true
                  elif [ "${{ runner.os }}" = "macOS" ]; then
                    cp target/dx/*/bundle/macos/bundle/macos/*.app artifacts/ 2>/dev/null || true
                    cp target/dx/*/bundle/macos/bundle/dmg/*.dmg artifacts/ 2>/dev/null || true
                  fi

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: desktop-${{ runner.os }}
                  path: artifacts/
                  retention-days: 1

    build-web:
        if: ${{ inputs.platform == 'all' || inputs.platform == 'web' }}
        name: Build Web Bundle
        runs-on: ubuntu-latest
        steps:
            - uses: nigeleke/github/.github/actions/os-prerequisites@main
              with:
                  os: ubuntu-latest

            - uses: nigeleke/github/.github/actions/dioxus-setup@main

            - uses: nigeleke/github/.github/actions/dioxus-bundle@main
              with:
                  platform: web

            - name: Collect web assets
              run: |
                  mkdir -p artifacts
                  zip -r artifacts/web-bundle.zip target/dx/*/release/web/public

            - name: Upload artifact
              uses: actions/upload-artifact@v6
              with:
                  name: web-bundle
                  path: artifacts/
                  retention-days: 1

    build-android:
        if: ${{ inputs.platform == 'all' || inputs.platform == 'android' }}
        name: Build Android Bundle
        runs-on: ubuntu-latest
        steps:
            - uses: nigeleke/github/.github/actions/os-prerequisites@main
              with:
                  os: ubuntu-latest

            - uses: nigeleke/github/.github/actions/dioxus-setup@main

            - uses: nigeleke/github/.github/actions/dioxus-android-setup@main

            - uses: nigeleke/github/.github/actions/dioxus-bundle@main
              with:
                  platform: android

            - name: Collect APK
              run: |
                  mkdir -p artifacts
                  cp target/dx/*/release/android/app/app/build/outputs/bundle/release/*.aab artifacts/

                  mapfile -t AABS < <(find target/dx/*/release/android/app/app/build/outputs/bundle/release -type f -name '*.aab')

                  if [ "${#AABS[@]}" -ne 1 ]; then
                    echo "Expected exactly one .aab, found ${#AABS[@]}"
                    printf '%s\n' "${AABS[@]}"
                    exit 1
                  fi

                  AAB="${AABS[0]}"
                  AAB_BASENAME=$(basename "$AAB")
                  AAB_STEM="${AAB_BASENAME%.aab}"

                  wget https://github.com/google/bundletool/releases/download/1.18.3/bundletool-all-1.18.3.jar -O bundletool.jar

                  java -jar bundletool.jar build-apks \
                    --bundle="$AAB" \
                    --output="$AAB_STEM.apks" \
                    --mode=universal

                  unzip "$AAB_STEM.apks" universal.apk -d artifacts
                  mv artifacts/universal.apk "artifacts/$AAB_STEM.apk"

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: android-bundle
                  path: artifacts/
                  retention-days: 1

    build-ios:
        if: ${{ inputs.platform == 'all' || inputs.platform == 'ios' }}
        name: Build iOS Bundle
        runs-on: macos-latest
        steps:
            - uses: nigeleke/github/.github/actions/os-prerequisites@main
              with:
                  os: macos-latest

            - uses: nigeleke/github/.github/actions/dioxus-setup@main

            - name: Add iOS targets
              run: rustup target add aarch64-apple-ios aarch64-apple-ios-sim x86_64-apple-ios

            - uses: nigeleke/github/.github/actions/dioxus-bundle@main
              with:
                  platform: ios

            - name: Collect IPA
              run: |
                  mkdir -p artifacts
                  cp dist/bundle/mobile/*.ipa artifacts/ 2>/dev/null || true

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ios-bundle
                  path: artifacts/
                  retention-days: 1
