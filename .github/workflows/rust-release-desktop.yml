name: Build & Release

on:
    workflow_call:
        inputs:
            packages:
                description: "Comma-separated list of Cargo packages to build (workspace members). If empty, builds the default crate"
                required: false
                type: string
                default: ""

jobs:
    build:
        name: Build ${{ matrix.target }}
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                    - os: windows-latest
                      target: x86_64-pc-windows-msvc
                    - os: macos-latest
                      target: aarch64-apple-darwin

        steps:
            - uses: actions/checkout@v6

            - name: Install OS prerequisites
              uses: nigeleke/github/.github/actions/os-prerequisites@main
              with:
                  os: ${{ matrix.os }}

            - name: Set up Rust
              uses: nigeleke/github/.github/actions/rust-setup@main

            - name: Build binaries
              shell: bash
              run: |
                  set -euxo pipefail

                  IFS=',' read -ra PACKAGES <<< "${{ inputs.packages }}"

                  SUFFIX=""
                  if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
                    SUFFIX="linux-latest"
                  elif [[ "${{ matrix.os }}" == "macos-latest" ]]; then
                    SUFFIX="macos-latest"
                  elif [[ "${{ matrix.os }}" == "windows-latest" ]]; then
                    SUFFIX="windows-latest"
                  fi

                  if [[ -z "${{ inputs.packages }}" || ${#PACKAGES[@]} -eq 0 ]]; then
                    cargo build --release --target "${{ matrix.target }}"
                    RELEASE_DIR="target/${{ matrix.target }}/release"
                    BIN_PATH=$(find "$RELEASE_DIR" -maxdepth 1 -type f -executable \
                      ! -name "*.dylib" ! -name "*.so" ! -name "*.dll" ! -name "*.pdb" \
                      ! -name "build" ! -name "deps" ! -name "native" 2>/dev/null | head -n 1)

                    if [[ -n "$BIN_PATH" ]]; then
                      BIN_NAME=$(basename "$BIN_PATH" .exe)
                      NEW_NAME="${BIN_NAME}-${SUFFIX}"
                      if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
                        NEW_NAME="${NEW_NAME}.exe"
                      fi
                      cp "$BIN_PATH" "$NEW_NAME"

                      PDB_PATH="$RELEASE_DIR/${BIN_NAME}.pdb"
                      if [[ -f "$PDB_PATH" ]]; then
                        cp "$PDB_PATH" "${BIN_NAME}-${SUFFIX}.pdb"
                      fi
                    else
                      echo "Warning: No main executable found in $RELEASE_DIR"
                    fi

                  else
                    for pkg in "${PACKAGES[@]}"; do
                      cargo build --release --target "${{ matrix.target }}" --package "$pkg"
                      RELEASE_DIR="target/${{ matrix.target }}/release"
                      BIN_NAME="$pkg"
                      BIN_PATH="$RELEASE_DIR/$BIN_NAME"
                      if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
                        BIN_PATH="$RELEASE_DIR/$BIN_NAME.exe"
                      fi

                      if [[ ! -f "$BIN_PATH" ]]; then
                        BIN_PATH=$(find "$RELEASE_DIR" -maxdepth 1 -type f -executable \
                          ! -name "*.dylib" ! -name "*.so" ! -name "*.dll" ! -name "*.pdb" \
                          | head -n 1)
                      fi

                      if [[ -n "$BIN_PATH" && -f "$BIN_PATH" ]]; then
                        BIN_NAME=$(basename "$BIN_PATH" .exe)
                        NEW_NAME="${BIN_NAME}-${SUFFIX}"
                        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
                          NEW_NAME="${NEW_NAME}.exe"
                        fi
                        cp "$BIN_PATH" "$NEW_NAME"

                        PDB_PATH="$RELEASE_DIR/${BIN_NAME}.pdb"
                        if [[ -f "$PDB_PATH" ]]; then
                          cp "$PDB_PATH" "${BIN_NAME}-${SUFFIX}.pdb"
                        fi
                      else
                        echo "Warning: No executable found for package $pkg in $RELEASE_DIR"
                      fi
                    done
                  fi

            - name: Upload binaries
              uses: actions/upload-artifact@v6
              with:
                  name: binaries-${{ matrix.target }}
                  path: |
                      *-linux-latest
                      *-macos-latest
                      *-windows-latest*
                      *-windows-latest.pdb
                  if-no-files-found: error
                  retention-days: 1

    release:
        name: Create GitHub Release
        needs: build
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/')

        steps:
            - uses: actions/checkout@v6

            - name: Download all platform binaries
              uses: actions/download-artifact@v7
              with:
                  path: binaries/
                  pattern: binaries-*

            - name: Create or update GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ github.ref_name }}
                  name: Release ${{ github.ref_name }}
                  generate_release_notes: true
                  files: binaries/**/*
                  fail_on_unmatched_files: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
