name: Build & Release

on:
    workflow_call:
        inputs:
            packages:
                description: "Comma-separated list of Cargo packages to build (workspace members). If empty, builds default crate."
                required: false
                type: string
                default: ""

jobs:
    strategy:
        matrix:
            include:
                - os: ubuntu-latest
                  target: x86_64-unknown-linux-gnu

                - os: windows-latest
                  target: x86_64-pc-windows-msvc

                - os: macos-latest
                  target: x86_64-apple-darwin
    build:
        runs-on: ${{matrix.os}}
        steps:
            - uses: actions/checkout@v6

            - uses: nigeleke/github/.github/actions/os-prerequisites@main
              with:
                  os: ${{matrix.os}}

            - uses: nigeleke/github/.github/actions/rust-setup@main

            - name: Build binaries
              shell: bash
              run: |
                  set -euxo pipefail

                  echo "Building for target: ${{ matrix.target }}"
                  echo "Packages: '${{ inputs.packages }}'"
                  echo "Use cross: '${{ inputs.use-cross }}'"

                  IFS=',' read -ra PACKAGES <<< "${{ inputs.packages }}"

                  if [[ -z "${{ inputs.packages }}" ]]; then
                    echo "Building default crate"
                    cargo build --release --target "${{ matrix.target }}"
                  else
                    for pkg in "${PACKAGES[@]}"; do
                      echo "Building package: $pkg"
                      cargo build \
                        --release \
                        --target "${{ matrix.target }}" \
                        --package "$pkg"
                    done
                  fi

                  echo "=== Release dir contents ==="
                  ls -lah "target/${{ matrix.target }}/release" || true

            - name: Upload binaries
              uses: actions/upload-artifact@v6
              with:
                  name: binaries-${{ matrix.target }}
                  path: |
                      target/${{ matrix.target }}/release/*
                      !target/${{ matrix.target }}/release/*.d
                      !target/${{ matrix.target }}/release/*.rlib
                      !target/${{ matrix.target }}/release/*.a

        release:
            needs: build
            runs-on: ubuntu-latest
            steps:
                - uses: actions/checkout@v6

                - uses: actions/download-artifact@v7
                  with:
                      path: ./binaries

                - name: Create GitHub Release
                  uses: softprops/action-gh-release@v1
                  with:
                      tag_name: ${{ github.ref_name }}
                      files: |
                          binaries/**/*
                  env:
                      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
